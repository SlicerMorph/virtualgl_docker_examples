#!/bin/sh

set -u
set -e
trap onexit INT
trap onexit TERM
trap onexit EXIT

XAUTHFILE=

onexit()
{
	if [ ! "$XAUTHFILE" = "" ]; then
		rm -f $XAUTHFILE
	fi
}

if [ -z ${VGL_DISPLAY+x} ]; then
	export VGL_DISPLAY=/dev/dri/card0
fi
XAUTHFILE=`mktemp ~/.Xauthority.XXXXXX`
case $VGL_DISPLAY in
*:*)
	if [ -f /etc/opt/VirtualGL/vgl_xauth_key ]; then
		xauth merge /etc/opt/VirtualGL/vgl_xauth_key
	fi
	xauth nlist $DISPLAY $VGL_DISPLAY | sed -e 's/^..../ffff/' | xauth -f $XAUTHFILE nmerge -
	;;
*)
	xauth nlist $DISPLAY | sed -e 's/^..../ffff/' | xauth -f $XAUTHFILE nmerge -
	;;
esac
chmod 444 $XAUTHFILE

. `dirname $0`/dockername
docker run \
	--device=/dev/dri \
	-e DISPLAY \
	-e VGL_DISPLAY \
	--gpus all \
	--ipc host \
	--rm \
	-v $XAUTHFILE:/home/docker/.Xauthority \
	-v /tmp/.X11-unix:/tmp/.X11-unix \
	$USER/$IMAGE \
	openbox-session
